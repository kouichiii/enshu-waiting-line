<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒã‚¹åœæ··é›‘çŠ¶æ³</title>
    <link rel="stylesheet" href="styles.css">
    <script src="config.js"></script>
    <script src="schedule.js"></script>
</head>
<body>
    <div class="container">
        <h1>ãƒã‚¹åœæ··é›‘çŠ¶æ³</h1>
        
        <div class="info-bar">
            <div class="update-info">
                <p id="last-updated">æœ€çµ‚æ›´æ–°: --</p>
                <p id="update-status" class="update-status">å¾…æ©Ÿä¸­</p>
            </div>
            <button id="refresh-btn" class="refresh-btn">æ›´æ–°</button>
        </div>
        

        
        <div id="error-message" class="error-message">
            ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚
        </div>
        
        <!-- å…¨ä½“ç’°å¢ƒãƒ»äºˆæ¸¬æƒ…å ± -->
        <div class="global-info">
            <div class="environment-data">
                <h3>ğŸŒ¡ï¸ ç’°å¢ƒæƒ…å ±</h3>
                <div class="env-details">
                    <span id="global-temperature" class="temp-info">æ°—æ¸©: --</span>
                    <span id="global-humidity" class="humidity-info">æ¹¿åº¦: --</span>
                </div>
            </div>
            <div class="prediction-data">
                <h3>ğŸ”® å¿«é©åº¦äºˆæ¸¬</h3>
                <div id="global-comfort" class="comfort-info">-- --</div>
            </div>
        </div>
        
        <div class="bus-stops">
            <!-- ãƒ¢ãƒã‚¤ãƒ«ç”¨ã‚¿ãƒ– -->
            <div class="mobile-tabs">
                <button class="tab-button active" data-tab="engineering">å·¥å­¦éƒ¨å‰</button>
                <button class="tab-button" data-tab="humanities">äººç§‘å‰</button>
            </div>
            
            <div class="bus-stop" id="engineering-stop" data-stop="engineering">
                <h2>å·¥å­¦éƒ¨å‰ï¼ˆå‡ºç™ºé§…ï¼‰</h2>
                <div class="congestion" id="engineering-congestion">
                    æ··é›‘çŠ¶æ³: ãƒ‡ãƒ¼ã‚¿ãªã—
                </div>
                <div class="departure-times" id="engineering-times">
                    <!-- ã“ã“ã«æ™‚åˆ»è¡¨ãƒ‡ãƒ¼ã‚¿ãŒå…¥ã‚Šã¾ã™ -->
                </div>
            </div>
            
            <div class="bus-stop" id="humanities-stop" data-stop="humanities">
                <h2>äººç§‘å‰ï¼ˆåœç•™æ‰€ï¼‰</h2>
                <div class="congestion" id="humanities-congestion">
                    æ··é›‘çŠ¶æ³: ãƒ‡ãƒ¼ã‚¿ãªã—
                </div>
                <div class="departure-times" id="humanities-times">
                    <!-- ã“ã“ã«æ™‚åˆ»è¡¨ãƒ‡ãƒ¼ã‚¿ãŒå…¥ã‚Šã¾ã™ -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // æ··é›‘åº¦ã®ãƒ©ãƒ™ãƒ«ï¼ˆ1-5ã®5æ®µéšè©•ä¾¡ï¼‰
        const congestionLabels = {
            1: { text: 'ç©ºã„ã¦ã„ã¾ã™', class: 'low' },
            2: { text: 'ã‚„ã‚„ç©ºã„ã¦ã„ã¾ã™', class: 'low' },
            3: { text: 'æ™®é€š', class: 'medium' },
            4: { text: 'ã‚„ã‚„æ··é›‘ã—ã¦ã„ã¾ã™', class: 'medium' },
            5: { text: 'æ··é›‘ã—ã¦ã„ã¾ã™', class: 'high' }
        };
        
        // å¿«é©åº¦ã®ãƒ©ãƒ™ãƒ«
        const comfortabilityLabels = {
            1: { text: 'éå¸¸ã«å¿«é©', class: 'very-good', emoji: 'ğŸ˜Š' },
            2: { text: 'å¿«é©', class: 'good', emoji: 'ğŸ™‚' },
            3: { text: 'æ™®é€š', class: 'normal', emoji: 'ğŸ˜' },
            4: { text: 'ã‚„ã‚„ä¸å¿«', class: 'bad', emoji: 'ğŸ˜•' },
            5: { text: 'ä¸å¿«', class: 'very-bad', emoji: 'ğŸ˜' }
        };

        // DOMè¦ç´ 
        const elements = {
            lastUpdated: document.getElementById('last-updated'),
            updateStatus: document.getElementById('update-status'),
            refreshBtn: document.getElementById('refresh-btn'),
            errorMessage: document.getElementById('error-message'),
            globalTemperature: document.getElementById('global-temperature'),
            globalHumidity: document.getElementById('global-humidity'),
            globalComfort: document.getElementById('global-comfort'),
            engineeringCongestion: document.getElementById('engineering-congestion'),
            humanitiesCongestion: document.getElementById('humanities-congestion'),
            engineeringTimes: document.getElementById('engineering-times'),
            humanitiesTimes: document.getElementById('humanities-times')
        };

        // æ®‹ã‚Šæ™‚é–“ã‚’è¨ˆç®—
        function calculateRemainingTime() {
            const now = new Date();
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            
            updateBusStopTimes('engineering', currentHour, currentMinute);
            updateBusStopTimes('humanities', currentHour, currentMinute);
        }

        // ãƒã‚¹åœã®æ™‚åˆ»è¡¨ã‚’æ›´æ–°
        function updateBusStopTimes(stopName, currentHour, currentMinute) {
            const scheduleData = window.BUS_SCHEDULE[stopName];
            const timesContainer = document.getElementById(`${stopName}-times`);
            
            // ã‚³ãƒ³ãƒ†ãƒŠã‚’ç©ºã«ã™ã‚‹
            timesContainer.innerHTML = '';
            
            // å…¨ã¦ã®ãƒã‚¹ç¨®é¡ã®å‡ºç™ºæ™‚åˆ»ã‚’çµ±åˆ
            const allDepartures = [];
            
            for (const [busType, typeData] of Object.entries(scheduleData)) {
                const busInfo = BUS_TYPES[busType.toUpperCase()];
                
                for (const hourData of typeData) {
                    const hour = hourData.hour;
                    
                    for (const minute of hourData.minutes) {
                        // æ™‚é–“ã‚’åˆ†ã«å¤‰æ›ã—ã¦æ¯”è¼ƒ
                        const departureInMinutes = hour * 60 + minute;
                        const currentInMinutes = currentHour * 60 + currentMinute;
                        
                        if (departureInMinutes >= currentInMinutes) {
                            allDepartures.push({
                                hour,
                                minute,
                                remainingMinutes: departureInMinutes - currentInMinutes,
                                busType: busType,
                                busInfo: busInfo
                            });
                        }
                    }
                }
            }
            
            // æ™‚åˆ»é †ã«ã‚½ãƒ¼ãƒˆ
            allDepartures.sort((a, b) => a.remainingMinutes - b.remainingMinutes);
            
            // æœ€åˆã®3ã¤ã®å‡ºç™ºæ™‚åˆ»ã‚’è¡¨ç¤º
            const nextDepartures = allDepartures.slice(0, 3);
            
            if (nextDepartures.length === 0) {
                timesContainer.innerHTML = '<p class="no-service">æœ¬æ—¥ã®é‹è¡Œã¯çµ‚äº†ã—ã¾ã—ãŸ</p>';
                return;
            }
            
            // æ¬¡ã®å‡ºç™ºæ™‚é–“ã‚’è¡¨ç¤º
            for (const departure of nextDepartures) {
                const timeElement = document.createElement('div');
                timeElement.className = 'departure-time';
                
                const leftSection = document.createElement('div');
                leftSection.className = 'time-section';
                
                const timeText = document.createElement('div');
                timeText.className = 'time-text';
                timeText.textContent = `${departure.hour}:${departure.minute.toString().padStart(2, '0')}`;
                
                const busTypeLabel = document.createElement('div');
                busTypeLabel.className = 'bus-type-label';
                busTypeLabel.style.backgroundColor = departure.busInfo.color;
                busTypeLabel.textContent = departure.busInfo.shortName;
                
                leftSection.appendChild(timeText);
                leftSection.appendChild(busTypeLabel);
                
                const rightSection = document.createElement('div');
                rightSection.className = 'remaining-section';
                
                const remainingText = document.createElement('div');
                remainingText.className = 'remaining-text';
                if (departure.remainingMinutes === 0) {
                    remainingText.textContent = 'å‡ºç™ºç›´å‰';
                    remainingText.classList.add('urgent');
                } else if (departure.remainingMinutes <= 5) {
                    remainingText.textContent = `ã‚ã¨${departure.remainingMinutes}åˆ†`;
                    remainingText.classList.add('soon');
                } else if (departure.remainingMinutes <= 10) {
                    remainingText.textContent = `ã‚ã¨${departure.remainingMinutes}åˆ†`;
                    remainingText.classList.add('medium');
                } else {
                    remainingText.textContent = `ã‚ã¨${departure.remainingMinutes}åˆ†`;
                    remainingText.classList.add('normal');
                }
                
                rightSection.appendChild(remainingText);
                
                timeElement.appendChild(leftSection);
                timeElement.appendChild(rightSection);
                timesContainer.appendChild(timeElement);
            }
        }

        // æ··é›‘åº¦ã‚’æ›´æ–°
        function updateCongestion(data) {
            // å…¨ä½“ç’°å¢ƒæƒ…å ±ãƒ»äºˆæ¸¬æƒ…å ±ã‚’æ›´æ–°
            updateGlobalInfo(data);
            
            // å·¥å­¦éƒ¨å‰ï¼ˆbusï¼‰ã®æ··é›‘åº¦ã‚’æ›´æ–°
            if (data.bus) {
                const busData = data.bus;
                const congestionLevel = busData.congestion_level || 3;
                
                // æ··é›‘åº¦ãƒ©ãƒ™ãƒ«ã®å–å¾—ï¼ˆ1-5ã®ç¯„å›²ã«èª¿æ•´ï¼‰
                const adjustedLevel = Math.min(Math.max(congestionLevel, 1), 5);
                const congestionInfo = congestionLabels[adjustedLevel];
                
                elements.engineeringCongestion.innerHTML = `
                    <div class="congestion-main">æ··é›‘çŠ¶æ³: ${congestionInfo.text}</div>
                    <div class="congestion-details">
                        <span class="gender-ratio">${formatGenderRatio(busData.gender_ratio)}</span>
                    </div>
                `;
                elements.engineeringCongestion.className = `congestion ${congestionInfo.class}`;
            }
            
            // äººç§‘å‰ï¼ˆqueueï¼‰ã®æ··é›‘åº¦ã‚’æ›´æ–°
            if (data.queue) {
                const queueData = data.queue;
                const queueCount = queueData.num_queue_people || 0;
                let congestionLevel;
                
                // å¾…æ©Ÿäººæ•°ã‹ã‚‰æ··é›‘åº¦ã‚’è¨ˆç®—ï¼ˆ1-5ã®5æ®µéšè©•ä¾¡ï¼‰
                if (queueCount === 0) {
                    congestionLevel = 1; // ç©ºã„ã¦ã„ã¾ã™
                } else if (queueCount <= 3) {
                    congestionLevel = 2; // ã‚„ã‚„ç©ºã„ã¦ã„ã¾ã™
                } else if (queueCount <= 8) {
                    congestionLevel = 3; // æ™®é€š
                } else if (queueCount <= 15) {
                    congestionLevel = 4; // ã‚„ã‚„æ··é›‘ã—ã¦ã„ã¾ã™
                } else {
                    congestionLevel = 5; // æ··é›‘ã—ã¦ã„ã¾ã™
                }
                
                const congestionInfo = congestionLabels[congestionLevel];
                
                elements.humanitiesCongestion.innerHTML = `
                    <div class="congestion-main">æ··é›‘çŠ¶æ³: ${congestionInfo.text}</div>
                    <div class="congestion-details">
                        <span class="queue-count">å¾…æ©Ÿäººæ•°: ${formatQueueCount(queueCount)}</span>
                        <span class="gender-ratio">${formatGenderRatio(queueData.gender_ratio)}</span>
                    </div>
                `;
                elements.humanitiesCongestion.className = `congestion ${congestionInfo.class}`;
            }
        }
        
        // å…¨ä½“æƒ…å ±ï¼ˆç’°å¢ƒãƒ»äºˆæ¸¬ï¼‰ã‚’æ›´æ–°
        function updateGlobalInfo(data) {
            // æ¸©åº¦ãƒ»æ¹¿åº¦ã®è¡¨ç¤ºï¼ˆqueueãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—ï¼‰
            if (data.queue) {
                const temperature = data.queue.temperature;
                const humidity = data.queue.humidity;
                
                elements.globalTemperature.textContent = temperature ? `æ°—æ¸©: ${temperature}Â°C` : 'æ°—æ¸©: --';
                elements.globalHumidity.textContent = humidity ? `æ¹¿åº¦: ${humidity}%` : 'æ¹¿åº¦: --';
            }
            
            // å¿«é©åº¦äºˆæ¸¬ã®è¡¨ç¤º
            if (data.predicted) {
                const comfortLevel = data.predicted.comfortability || 3;
                const comfortInfo = comfortabilityLabels[comfortLevel] || comfortabilityLabels[3];
                
                elements.globalComfort.innerHTML = `${comfortInfo.emoji} ${comfortInfo.text}`;
                elements.globalComfort.className = `comfort-info ${comfortInfo.class}`;
            } else {
                elements.globalComfort.textContent = '-- --';
                elements.globalComfort.className = 'comfort-info';
            }
        }

        // ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°æ™‚é–“ã‚’è¡¨ç¤º
        function updateLastUpdated(data = null) {
            let displayTime;
            let relativeTime;
            let receivedAt = null;
            
            // æœ€æ–°ã®å—ä¿¡æ™‚åˆ»ã‚’å–å¾—ï¼ˆbusã¨queueã®ã†ã¡æ–°ã—ã„æ–¹ï¼‰
            if (data) {
                const busTime = data.bus?.received_at ? new Date(data.bus.received_at) : null;
                const queueTime = data.queue?.received_at ? new Date(data.queue.received_at) : null;
                
                if (busTime && queueTime) {
                    receivedAt = busTime > queueTime ? busTime : queueTime;
                } else if (busTime) {
                    receivedAt = busTime;
                } else if (queueTime) {
                    receivedAt = queueTime;
                }
            }
            
            if (receivedAt) {
                const now = new Date();
                const timeDiff = Math.floor((now - receivedAt) / 1000); // ç§’å˜ä½
                
                const formattedDate = `${receivedAt.getFullYear()}/${(receivedAt.getMonth() + 1).toString().padStart(2, '0')}/${receivedAt.getDate().toString().padStart(2, '0')}`;
                const formattedTime = `${receivedAt.getHours().toString().padStart(2, '0')}:${receivedAt.getMinutes().toString().padStart(2, '0')}:${receivedAt.getSeconds().toString().padStart(2, '0')}`;
                displayTime = `æœ€çµ‚æ›´æ–°: ${formattedDate} ${formattedTime}`;
                
                // ç›¸å¯¾æ™‚é–“ã®è¨ˆç®—
                if (timeDiff < 60) {
                    relativeTime = `${timeDiff}ç§’å‰ã«æ›´æ–°`;
                } else if (timeDiff < 3600) {
                    relativeTime = `${Math.floor(timeDiff / 60)}åˆ†å‰ã«æ›´æ–°`;
                } else {
                    relativeTime = `${Math.floor(timeDiff / 3600)}æ™‚é–“å‰ã«æ›´æ–°`;
                }
            } else {
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šç¾åœ¨æ™‚åˆ»ã‚’ä½¿ç”¨
                const now = new Date();
                const formattedDate = `${now.getFullYear()}/${(now.getMonth() + 1).toString().padStart(2, '0')}/${now.getDate().toString().padStart(2, '0')}`;
                const formattedTime = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
                displayTime = `æœ€çµ‚æ›´æ–°: ${formattedDate} ${formattedTime}`;
                relativeTime = 'ä»Šæ›´æ–°';
            }
            
            elements.lastUpdated.textContent = displayTime;
            elements.updateStatus.textContent = relativeTime;
            elements.updateStatus.className = 'update-status';
        }

        // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        async function fetchBusStatus() {
            elements.errorMessage.style.display = 'none';
            elements.refreshBtn.disabled = true;
            elements.refreshBtn.textContent = 'æ›´æ–°ä¸­...';
            elements.updateStatus.textContent = 'ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...';
            elements.updateStatus.className = 'update-status updating';
            
            try {
                const response = await fetch(API_CONFIG.BASE_URL + API_CONFIG.ENDPOINTS.BUS_STATUS);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
                updateCongestion(data);
                updateLastUpdated(data);
                calculateRemainingTime();
                
                // æ›´æ–°å®Œäº†
                elements.refreshBtn.disabled = false;
                elements.refreshBtn.textContent = 'æ›´æ–°';
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                elements.errorMessage.style.display = 'block';
                elements.refreshBtn.disabled = false;
                elements.refreshBtn.textContent = 'æ›´æ–°';
                elements.updateStatus.textContent = 'æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ';
                elements.updateStatus.className = 'update-status error';
            }
        }

        // åˆæœŸåŒ–
        function init() {
            // æ›´æ–°ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            elements.refreshBtn.addEventListener('click', fetchBusStatus);
            
            // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ï¼ˆãƒ¢ãƒã‚¤ãƒ«ç”¨ï¼‰
            initMobileTabs();
            
            // 1åˆ†ã”ã¨ã«æ®‹ã‚Šæ™‚é–“ã‚’æ›´æ–°
            setInterval(calculateRemainingTime, 1000);
            
            // åˆæœŸãƒ‡ãƒ¼ã‚¿å–å¾—
            fetchBusStatus();
            
            // åˆæœŸæ™‚åˆ»è¡¨è¡¨ç¤º
            calculateRemainingTime();
        }
        
        // ãƒ¢ãƒã‚¤ãƒ«ã‚¿ãƒ–ã®åˆæœŸåŒ–
        function initMobileTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const busStops = document.querySelectorAll('.bus-stop');
            
            // åˆæœŸçŠ¶æ…‹ï¼šå·¥å­¦éƒ¨å‰ã‚’è¡¨ç¤º
            showBusStop('engineering');
            
            // ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
            tabButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    const targetTab = e.target.dataset.tab;
                    
                    // ã™ã¹ã¦ã®ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã‹ã‚‰ active ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    
                    // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚¿ãƒ–ãƒœã‚¿ãƒ³ã« active ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
                    e.target.classList.add('active');
                    
                    // ãƒã‚¹åœã‚’åˆ‡ã‚Šæ›¿ãˆ
                    showBusStop(targetTab);
                });
            });
        }
        
        // ãƒã‚¹åœã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        function showBusStop(stopName) {
            const busStops = document.querySelectorAll('.bus-stop');
            
            busStops.forEach(stop => {
                const stopData = stop.dataset.stop;
                if (stopData === stopName) {
                    stop.classList.add('active');
                } else {
                    stop.classList.remove('active');
                }
            });
        }

        // æ€§åˆ¥æ¯”ç‡ã‚’æ—¥æœ¬èªã«å¤‰æ›
        function formatGenderRatio(genderRatio) {
            if (!genderRatio || genderRatio === 'ãƒ‡ãƒ¼ã‚¿ãªã—') {
                return 'ãƒ‡ãƒ¼ã‚¿ãªã—';
            }
            
            // gender_ratioãŒæ–‡å­—åˆ—ã®å ´åˆã€è‹±èªã‚’æ—¥æœ¬èªã«å¤‰æ›
            const japaneseRatio = genderRatio
                .replace(/female/g, 'å¥³æ€§')
                .replace(/male/g, 'ç”·æ€§');
            
            return japaneseRatio;
        }

        // å¾…æ©Ÿäººæ•°ã‚’5äººå˜ä½ã§ä¸¸ã‚ã¦è¡¨ç¤º
        function formatQueueCount(count) {
            if (count === 0) {
                return '0äºº';
            }
            
            // 5äººå˜ä½ã§ä¸¸ã‚ã‚‹
            const rounded = Math.ceil(count / 5) * 5;
            return `ç´„${rounded}äºº`;
        }

        // DOMãŒèª­ã¿è¾¼ã¾ã‚ŒãŸã‚‰åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
